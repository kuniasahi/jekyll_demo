---
layout: post
author: yuguoxu
author_url: http://yuguoxusblog.tk/
author_email: yokuniasahi@gmail.com
title: 关于C语言中的setjump和longjump
published_date: 2013-2-17
---

<p>
   闲着翻了一下《advanced programming in the linux》，发现这本书不愧是网上推荐的神作，今天先看了一下关于setjump和longjump的介绍
</p>

<p>
  C的goto语句是很不错的跳转语句，特别是用在错误处理上，但goto的缺点是只能用于函数内，那有没有函数外也能用的呢，有，那就是setjump和
  longjump,举个栗子，把setjump理解成设置标号就行了，longjump就是跳转语句
</p>

<p>
  使用前需要引入setjump.h头文件和定义一个jmp_buf的结构体，下面是apue给出的example
</p>

     <div style="background:#fdfdfd;color:black;"><u>C语言</u>: </div>
     <div style="font-family: &quot;[object HTMLOptionElement]&quot;,&quot;Courier New&quot;,&quot;monospace&quot;,&quot;Verdana&quot;; color: rgb(0, 0, 0);" class="source"><span style="color: rgb(0, 128, 128);">#include &quot;apue.h&quot;</span><br><span style="color: rgb(0, 128, 128);">#include &lt;setjmp.h&gt;</span><br><br><span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">f1</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">int</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span>);<br><span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">f2</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">void</span>);<br><br><span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">jmp_buf</span> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">jmpbuffer</span>;<br><span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">globval</span>;<br><br><span style="color: rgb(0, 0, 128); font-weight: bold;">int</span><br><span style="color: rgb(0, 0, 0);">main</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">void</span>)<br><span style="color: rgb(0, 0, 0);">{</span><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">autoval</span>;<br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 128); font-weight: bold;">register</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">regival</span>;<br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 128); font-weight: bold;">volatile</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">volaval</span>;<br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">statval</span>;<br><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">globval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">1</span>; <span style="color: rgb(0, 0, 0);">autoval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">2</span>; <span style="color: rgb(0, 0, 0);">regival</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">3</span>; <span style="color: rgb(0, 0, 0);">volaval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">4</span>; <span style="color: rgb(0, 0, 0);">statval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">5</span>;<br><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 128); font-weight: bold;">if</span> (<span style="color: rgb(0, 0, 0);">setjmp</span>(<span style="color: rgb(0, 0, 0);">jmpbuffer</span>) <span style="color: rgb(0, 0, 0);">!=</span> <span style="color: rgb(0, 0, 255);">0</span>) <span style="color: rgb(0, 0, 0);">{</span><br> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">printf</span>(<span style="color: rgb(0, 0, 255);">&quot;after longjmp:</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">&quot;</span>);<br> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">printf</span>(<span style="color: rgb(0, 0, 255);">&quot;globval = %d, autoval = %d, regival = %d,&quot;</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 255);">&quot; volaval = %d, statval = %d</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">&quot;</span><span style="color: rgb(0, 0, 0);">,</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">globval</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">autoval</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">regival</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">volaval</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">statval</span>);<br> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">exit</span>(<span style="color: rgb(0, 0, 255);">0</span>);<br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">}</span><br><br> &nbsp; &nbsp;<span style="color: rgb(0, 136, 0); font-style: italic;">/*</span><br><span style="color: rgb(0, 136, 0); font-style: italic;"> &nbsp; &nbsp; * Change variables after setjmp, but before longjmp.</span><br><span style="color: rgb(0, 136, 0); font-style: italic;"> &nbsp; &nbsp; */</span><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">globval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">95</span>; <span style="color: rgb(0, 0, 0);">autoval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">96</span>; <span style="color: rgb(0, 0, 0);">regival</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">97</span>; <span style="color: rgb(0, 0, 0);">volaval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">98</span>;<br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">statval</span> <span style="color: rgb(0, 0, 0);">=</span> <span style="color: rgb(0, 0, 255);">99</span>;<br><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">f1</span>(<span style="color: rgb(0, 0, 0);">autoval</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">regival</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">volaval</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">statval</span>); &nbsp; &nbsp;<span style="color: rgb(0, 136, 0); font-style: italic;">/* never returns */</span><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">exit</span>(<span style="color: rgb(0, 0, 255);">0</span>);<br><span style="color: rgb(0, 0, 0);">}</span><br><br><span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span><br><span style="color: rgb(0, 0, 0);">f1</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">i</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">j</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">k</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">int</span> <span style="color: rgb(0, 0, 0);">l</span>)<br><span style="color: rgb(0, 0, 0);">{</span><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">printf</span>(<span style="color: rgb(0, 0, 255);">&quot;in f1():</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">&quot;</span>);<br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">printf</span>(<span style="color: rgb(0, 0, 255);">&quot;globval = %d, autoval = %d, regival = %d,&quot;</span><br> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(0, 0, 255);">&quot; volaval = %d, statval = %d</span><span style="color: rgb(0, 0, 255);">\n</span><span style="color: rgb(0, 0, 255);">&quot;</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">globval</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">i</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">j</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">k</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 0);">l</span>);<br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">f2</span>();<br><span style="color: rgb(0, 0, 0);">}</span><br><br><span style="color: rgb(0, 0, 128); font-weight: bold;">static</span> <span style="color: rgb(0, 0, 128); font-weight: bold;">void</span><br><span style="color: rgb(0, 0, 0);">f2</span>(<span style="color: rgb(0, 0, 128); font-weight: bold;">void</span>)<br><span style="color: rgb(0, 0, 0);">{</span><br> &nbsp; &nbsp;<span style="color: rgb(0, 0, 0);">longjmp</span>(<span style="color: rgb(0, 0, 0);">jmpbuffer</span><span style="color: rgb(0, 0, 0);">,</span> <span style="color: rgb(0, 0, 255);">1</span>);<br><span style="color: rgb(0, 0, 0);">}</span><br></div>
  

<p>
    以后会写一些更多关于android的东西，学习路上，与君共勉！
</p>

